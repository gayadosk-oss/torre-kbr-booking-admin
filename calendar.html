<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Torre KBR • Booking Calendar (2026)</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 28px rgba(17,24,39,.08);
      --accent:#2563eb;

      --availBg:#dcfce7; --availText:#166534; --availBorder:#bbf7d0;
      --bookBg:#fee2e2; --bookText:#991b1b; --bookBorder:#fecaca;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
      background:#fff;
      position:sticky; top:0; z-index:5;
    }
    .headerInner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .sub{margin:4px 0 0; color:var(--muted); font-size:13px}
    .mainLink{
      text-decoration:none;
      background:#111827;
      color:#ffffff;
      padding:8px 16px;
      border-radius:10px;
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow);
    }
    .left,.right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select,button,input{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      color:var(--text);
      min-height:40px;
    }
    button{cursor:pointer}
    button.primary{background:var(--accent); color:#fff; border-color:transparent}
    button.ghost{background:#fff}

    .grid{
      margin-top:14px;
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow);
    }
    .monthTitle{display:flex; align-items:baseline; justify-content:space-between; padding:6px 6px 10px; gap:10px; flex-wrap:wrap}
    .monthTitle strong{font-size:18px}
    .monthTitle span{color:var(--muted); font-size:13px}

    .dow{display:grid; grid-template-columns:repeat(7,1fr); gap:10px; padding:0 6px 8px}
    .dow div{color:var(--muted); font-weight:800; font-size:12px; text-transform:uppercase}

    .days{
      display:grid;
      grid-template-columns:repeat(7, minmax(0,1fr));
      gap:10px;
      padding:0 6px 6px;
      align-items:stretch;
    }
    .day{
      min-height:92px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:#fff;
      display:flex; flex-direction:column; gap:8px;
      transition:transform .05s ease, box-shadow .05s ease;
      position:relative;
      outline:none;
    }
    .day:hover{transform:translateY(-1px); box-shadow:0 8px 16px rgba(17,24,39,.06)}
    .day.muted{background:#fafafa; color:#9ca3af}
    .date{font-weight:900; font-size:13px}
    .miniRow{display:flex; gap:6px; flex-wrap:wrap; margin-top:auto}
    .pill{
      font-size:11px; font-weight:900;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid transparent;
      line-height:1.1;
    }
    .pill.av{background:var(--availBg); color:var(--availText); border-color:var(--availBorder)}
    .pill.bk{background:var(--bookBg); color:var(--bookText); border-color:var(--bookBorder)}
    .hint{font-size:11px; color:var(--muted)}

    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(17,24,39,.55);
      display:none;

      overflow:auto;
      -webkit-overflow-scrolling:touch;

      padding:16px;
      z-index:50;

      align-items:flex-start;
      justify-content:center;
    }

    .modal{
      width:min(820px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      border:1px solid var(--border);

      max-height:calc(100vh - 32px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;

      margin:0 auto;
      padding:14px;
      padding-bottom:calc(14px + env(safe-area-inset-bottom));
    }

    .modalHeader{
      position:sticky;
      top:0;
      background:#fff;
      z-index:5;

      margin:-14px -14px 0;
      padding:14px;
      border-bottom:1px solid var(--border);
      border-top-left-radius:16px;
      border-top-right-radius:16px;

      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modalHeader strong{font-size:16px}
    .modalHeader button{padding:8px 10px}

    .modalBody{margin-top:12px; display:grid; gap:12px}
    .unitGrid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .unitCard{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:#fff;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .unitName{font-weight:950; font-size:13px}
    .unitSelect{
      width:140px;
      padding:8px 10px;
      border-radius:12px;
      font-weight:900;
      border:1px solid var(--border);
      background:#fff;
    }
    .unitSelect.av{background:var(--availBg); color:var(--availText); border-color:var(--availBorder)}
    .unitSelect.bk{background:var(--bookBg); color:var(--bookText); border-color:var(--bookBorder)}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;
      border-top:1px solid var(--border);
      padding-top:12px;
    }
    .actionsLeft,.actionsRight{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .small{font-size:12px; color:var(--muted)}
    .footerNote{margin-top:10px; color:var(--muted); font-size:12px; text-align:center}

    @media (max-width:860px){
      .unitGrid{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    @media (max-width:720px){
      .dow{display:none}
      .days{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    @media (max-width:520px){
      .day{min-height:82px}
      .unitGrid{grid-template-columns:1fr}
      .unitSelect{width:160px}

      .headerInner{flex-direction:column; align-items:flex-start}
      .mainLink{align-self:flex-end}
    }
  </style>
</head>
<body>

<header>
  <div class="headerInner">
    <div style="text-align:left;">
      <h1>Torre KBR • Booking Calendar</h1>
      <p class="sub">2026 • Click a date → Set units to Available or Booked</p>
    </div>
    <a class="mainLink" href="index.html">⬅ Main Menu</a>
  </div>
</header>

<div class="wrap">
  <div class="toolbar">
    <div class="left">
      <span class="small"><b>Month</b></span>
      <select id="monthSelect"></select>
      <button class="ghost" id="prevBtn" type="button">◀ Prev</button>
      <button class="ghost" id="nextBtn" type="button">Next ▶</button>
      <button class="ghost" id="todayBtn" type="button">Go to Jan 2026</button>
    </div>
    <div class="right">
      <button class="ghost" id="exportBtn" type="button">Export</button>
      <button class="ghost" id="importBtn" type="button">Import</button>
    </div>
  </div>

  <div class="grid">
    <div class="monthTitle">
      <strong id="monthTitle"></strong>
      <span id="monthMeta"></span>
    </div>

    <div class="dow">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>

    <div class="days" id="daysGrid"></div>
  </div>

  <div class="footerNote">Tip: Use Export to back up / transfer to another device.</div>
</div>

<div class="modalOverlay" id="modalOverlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHeader">
      <strong id="modalTitle">Edit</strong>
      <button class="ghost" id="closeModalBtn" type="button">✕</button>
    </div>

    <div class="modalBody">
      <div class="small" id="modalSub"></div>

      <div class="unitGrid" id="unitGrid"></div>

      <div class="actions">
        <div class="actionsLeft">
          <button class="ghost" id="setAllAvailableBtn" type="button">Set all Available</button>
          <button class="ghost" id="setAllBookedBtn" type="button">Set all Booked</button>
        </div>
        <div class="actionsRight">
          <button class="ghost" id="cancelBtn" type="button">Close</button>
          <button class="primary" id="saveBtn" type="button">Save</button>
        </div>
      </div>

      <div class="small" id="saveStatus">Saved locally in this browser (no login needed).</div>
    </div>
  </div>
</div>

<script>
  // ====== Config ======
  const YEAR = 2026;
  const STORAGE_KEY = `torre-kbr-units-${YEAR}`;

  // ====== Remote storage (Google Sheets via Apps Script) ======
  const API_URL = "https://script.google.com/macros/s/AKfycbxhgciD9s7x4pPtyGffjzPhLED_DQ0eONXj_iVsKoQu-meszK9O6JRNyQT0YKvBqxg1xQ/exec";
  const API_KEY = "kbr_super_secret_2026";
  const CAL_TAB = "calendar";
  const CAL_KEY = STORAGE_KEY; // one record for the whole year

  // Units
  const UNITS = ["D1","D2","C1","C2","C3","B1","B2","A1","A2","ROOM A","ROOM B","ROOM C"];

  // data shape:
  // { "2026-02-14": { "D1":"available", "D2":"booked", ... }, ... }
  let data = {}; // loaded on init

  // ===== iOS Background Scroll Lock =====
  let __scrollY = 0;
  function lockBodyScroll(){
    __scrollY = window.scrollY || 0;
    document.body.style.position = "fixed";
    document.body.style.top = `-${__scrollY}px`;
    document.body.style.left = "0";
    document.body.style.right = "0";
    document.body.style.width = "100%";
  }
  function unlockBodyScroll(){
    const top = document.body.style.top;
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.left = "";
    document.body.style.right = "";
    document.body.style.width = "";
    const y = top ? Math.abs(parseInt(top, 10)) : __scrollY;
    window.scrollTo(0, y || 0);
  }

  // ====== Elements ======
  const monthSelect = document.getElementById("monthSelect");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const todayBtn = document.getElementById("todayBtn");
  const monthTitle = document.getElementById("monthTitle");
  const monthMeta = document.getElementById("monthMeta");
  const daysGrid = document.getElementById("daysGrid");

  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const saveBtn = document.getElementById("saveBtn");
  const setAllAvailableBtn = document.getElementById("setAllAvailableBtn");
  const setAllBookedBtn = document.getElementById("setAllBookedBtn");
  const unitGrid = document.getElementById("unitGrid");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");

  const saveStatus = document.getElementById("saveStatus");

  const MONTHS = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];

  // ====== Remote storage helpers ======
  function setStatus(msg){
    if (!saveStatus) return;
    saveStatus.textContent = msg;
  }

  async function apiGet(tab, key){
    const url = `${API_URL}?key=${encodeURIComponent(API_KEY)}&tab=${encodeURIComponent(tab)}&k=${encodeURIComponent(key)}`;
    const res = await fetch(url, { method: "GET" });
    if (!res.ok) throw new Error("API GET failed");
    const out = await res.json();
    return out?.data ?? null;
  }

  async function apiSet(tab, key, obj){
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ key: API_KEY, tab, k: key, data: obj })
    });
    if (!res.ok) throw new Error("API POST failed");
    return res.json();
  }

  async function loadData(){
    // Cloud first (shared across devices)
    try{
      const cloud = await apiGet(CAL_TAB, CAL_KEY);
      if (cloud && typeof cloud === "object") return cloud;
    }catch(e){
      console.warn("Cloud load failed, using local cache.", e);
    }

    // Local fallback
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : {};
    }catch{
      return {};
    }
  }

  // Debounced save (prevents spamming writes)
  let __saveTimer = null;
  function persistSoon(){
    clearTimeout(__saveTimer);
    __saveTimer = setTimeout(() => {
      persist().catch(console.error);
    }, 500);
  }

  async function persist(){
    setStatus("Saving...");
    // Local cache
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }catch{}

    // Cloud save
    try{
      await apiSet(CAL_TAB, CAL_KEY, data);
      setStatus("Saved to Google Sheets (syncs across devices).");
    }catch(e){
      console.warn("Cloud save failed, kept locally.", e);
      setStatus("Saved locally only (cloud sync failed).");
    }
  }

  // ====== Month selector ======
  MONTHS.forEach((m, idx) => {
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = `${m} ${YEAR}`;
    monthSelect.appendChild(opt);
  });

  let currentMonth = 0; // default Jan
  monthSelect.value = String(currentMonth);

  monthSelect.addEventListener("change", () => {
    currentMonth = Number(monthSelect.value);
    render();
  });

  prevBtn.addEventListener("click", () => {
    currentMonth = Math.max(0, currentMonth - 1);
    monthSelect.value = String(currentMonth);
    render();
  });

  nextBtn.addEventListener("click", () => {
    currentMonth = Math.min(11, currentMonth + 1);
    monthSelect.value = String(currentMonth);
    render();
  });

  todayBtn.addEventListener("click", () => {
    currentMonth = 0;
    monthSelect.value = "0";
    render();
  });

  // ====== Calendar render ======
  function render() {
    const first = new Date(YEAR, currentMonth, 1);
    const last = new Date(YEAR, currentMonth + 1, 0);
    const firstDow = first.getDay();
    const daysInMonth = last.getDate();

    monthTitle.textContent = `${MONTHS[currentMonth]} ${YEAR}`;
    monthMeta.textContent = `Click any date to edit unit availability`;

    daysGrid.innerHTML = "";

    for (let i = 0; i < firstDow; i++) {
      const blank = document.createElement("div");
      blank.className = "day muted";
      blank.innerHTML = `<div class="date">&nbsp;</div>`;
      daysGrid.appendChild(blank);
    }

    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = toISODate(YEAR, currentMonth + 1, d);
      const unitMap = getDateMap(dateStr);

      const counts = countStatus(unitMap);
      const el = document.createElement("div");
      el.className = "day";
      el.setAttribute("role","button");
      el.setAttribute("tabindex","0");

      el.addEventListener("click", () => openModal(dateStr));
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") openModal(dateStr);
      });

      el.innerHTML = `
        <div class="date">${MONTHS[currentMonth].slice(0,3)} ${d}</div>
        <div class="hint">${counts.booked} booked • ${counts.available} available</div>
        <div class="miniRow">
          <span class="pill bk">${counts.booked} Booked</span>
          <span class="pill av">${counts.available} Available</span>
        </div>
      `;

      daysGrid.appendChild(el);
    }
  }

  function getDateMap(dateStr){
    const existing = data[dateStr];
    if (existing && typeof existing === "object") {
      const safe = {};
      for (const u of UNITS) safe[u] = (existing[u] === "booked") ? "booked" : "available";
      return safe;
    }
    const fresh = {};
    for (const u of UNITS) fresh[u] = "available";
    return fresh;
  }

  function countStatus(map){
    let booked = 0, available = 0;
    for (const u of UNITS){
      if (map[u] === "booked") booked++;
      else available++;
    }
    return { booked, available };
  }

  // ====== Modal ======
  let activeDate = null;
  let workingMap = null;

  function openModal(dateStr){
    activeDate = dateStr;
    workingMap = getDateMap(dateStr);

    modalTitle.textContent = `Edit Units • ${dateStr}`;
    modalSub.textContent = `Tap each unit and set it to Available or Booked.`;

    unitGrid.innerHTML = "";
    for (const unit of UNITS){
      const card = document.createElement("div");
      card.className = "unitCard";

      const name = document.createElement("div");
      name.className = "unitName";
      name.textContent = unit;

      const select = document.createElement("select");
      select.className = "unitSelect";
      select.innerHTML = `
        <option value="available">Available</option>
        <option value="booked">Booked</option>
      `;
      select.value = workingMap[unit] || "available";
      applySelectStyle(select);

      select.addEventListener("change", () => {
        workingMap[unit] = select.value;
        applySelectStyle(select);
      });

      card.appendChild(name);
      card.appendChild(select);
      unitGrid.appendChild(card);
    }

    lockBodyScroll();
    modalOverlay.style.display = "flex";
    modalOverlay.scrollTop = 0;
  }

  function applySelectStyle(sel){
    sel.classList.remove("av","bk");
    if (sel.value === "booked") sel.classList.add("bk");
    else sel.classList.add("av");
  }

  function closeModal(){
    modalOverlay.style.display = "none";
    unlockBodyScroll();
    activeDate = null;
    workingMap = null;
  }

  closeModalBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closeModal();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalOverlay.style.display === "flex") closeModal();
  });

  setAllAvailableBtn.addEventListener("click", () => {
    if (!workingMap) return;
    for (const u of UNITS) workingMap[u] = "available";
    [...unitGrid.querySelectorAll("select")].forEach(s => { s.value="available"; applySelectStyle(s); });
  });

  setAllBookedBtn.addEventListener("click", () => {
    if (!workingMap) return;
    for (const u of UNITS) workingMap[u] = "booked";
    [...unitGrid.querySelectorAll("select")].forEach(s => { s.value="booked"; applySelectStyle(s); });
  });

  saveBtn.addEventListener("click", () => {
    if (!activeDate || !workingMap) return;
    data[activeDate] = { ...workingMap };
    persistSoon();
    render();
    closeModal();
  });

  // ====== Export / Import ======
  exportBtn.addEventListener("click", () => {
    const payload = JSON.stringify({ year: YEAR, units: UNITS, data }, null, 2);
    const blob = new Blob([payload], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `torre-kbr-availability-${YEAR}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  importBtn.addEventListener("click", async () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const file = input.files?.[0];
      if (!file) return;
      const text = await file.text();
      try{
        const parsed = JSON.parse(text);
        if (!parsed || typeof parsed !== "object" || !parsed.data) {
          alert("Invalid file.");
          return;
        }
        data = parsed.data;
        persistSoon();
        render();
        alert("Imported successfully!");
      }catch{
        alert("Invalid JSON file.");
      }
    };
    input.click();
  });

  // ====== Helpers ======
  function toISODate(y,m,d){
    return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
  }

  // init (load cloud first, then render)
  (async function init(){
    setStatus("Loading from Google Sheets...");
    data = await loadData();
    render();
    setStatus("Ready. Changes will sync across devices when you Save.");
  })();
</script>
</body>
</html>
